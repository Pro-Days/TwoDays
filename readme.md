# TwoDays

디스코드 슬래시 명령으로 한월RPG의 유저 정보(랭킹/검색/분포/등록)를 조회하는 봇입니다.

이 문서는 다음 순서로 구성되어 있습니다.

1. 일반 사용자용 디스코드 봇 사용 가이드
2. 개발자용 프로젝트 가이드

## 일반 사용자 가이드

### 무엇을 할 수 있나요?

- `/랭킹`: 레벨/전투력 랭킹 조회
- `/검색`: 특정 캐릭터의 레벨/전투력/랭킹 히스토리 조회
- `/유저분포`: 특정 날짜 기준 유저 레벨 분포 조회
- `/등록`: 캐릭터를 추적 대상 목록에 등록
- `/질문`: FAQ 질문에 대한 답변/유사 질문 제시

### 봇 설치 방법

아직 봇 설치 URL은 준비 중입니다. 준비되면 아래 빈 칸에 URL을 추가하세요.

- 설치 URL: `(추후 추가 예정)`

설치 절차:

1. 위 설치 URL에 접속합니다.
2. 디스코드 계정으로 로그인합니다.
3. 설치하고 싶은 방법을 선택합니다. (예: `내 앱`, `서버`)
4. 화면 안내에 따라 설치를 완료합니다.

### 시작하기

1. 봇이 설치된 디스코드 서버(또는 사용 가능한 환경)에서 채팅 입력창에 `/` 를 입력합니다.
2. 명령 목록에서 `랭킹`, `검색`, `유저분포`, `등록` 중 하나를 선택합니다.
3. 필요한 옵션을 입력하고 실행합니다.
4. 필요하면 `나만보기` 옵션을 켜서 본인에게만 보이도록 응답받을 수 있습니다.

### 공통 입력 규칙

#### `나만보기` 옵션

- 명령에 `나만보기` 옵션이 있습니다.
- 켜면(True) 다른 사람에게 응답 메시지가 보이지 않도록 처리됩니다.

#### 컨텍스트 메뉴: `메시지 삭제`

- 봇이 보낸 응답 메시지에서 우클릭(모바일은 길게 누르기) → 앱(Apps) → `메시지 삭제`를 선택합니다.
- 본인이 요청한 응답만 삭제할 수 있으며, 관리자 계정은 예외적으로 삭제 가능합니다.
- 삭제 결과는 나만보기로 표시됩니다.

#### 날짜 입력 형식 (`날짜`)

다음 형식을 지원합니다.

- `YYYY-MM-DD` 예: `2026-03-07`
- `MM-DD` 예: `12-01` (연도는 올해로 해석)
- `DD` 예: `05` (연/월은 오늘 기준으로 해석)
- `-n` 예: `-1`, `-20` (오늘로부터 n일 전)

주의:

- 미래 날짜는 조회할 수 없습니다.
- 명령에 따라 오늘 날짜가 허용되지 않을 수 있습니다. (`/유저분포`는 오늘 날짜 금지)
- 특정 날짜의 플레이어 정보는 보통 해당 날짜의 다음 날 `00시` 전후(집계 시점 기준) 데이터입니다.
    예: `01월 01일` 데이터는 `01월 02일 00시` 전후 기준 데이터

#### 기간 입력 (`기간`)

- 명령에 따라 기간 옵션은 변화량/히스토리 조회에 사용됩니다.
- 디스코드 명령 정의상 최소값은 `2`로 설정되어 있습니다.
- 입력하지 않으면 명령별 기본값이 적용됩니다. (예: `/검색`은 기본 `7`)

#### 랭킹 범위 입력 (`랭킹범위`)

- 형식: `시작..끝`
- 예시: `1..10`, `70..100`
- 허용 범위: `1~100`
- 시작값은 끝값보다 작거나 같아야 합니다.

### 명령별 상세 사용법

#### `/랭킹`

캐릭터 랭킹을 조회합니다. 하위 명령으로 `레벨`, `전투력`을 선택할 수 있습니다.

사용 예시:

- `/랭킹 레벨`
- `/랭킹 레벨 랭킹범위:1..10`
- `/랭킹 전투력 랭킹범위:50..80 날짜:-1`
- `/랭킹 레벨 랭킹범위:1..20 기간:7 날짜:2026-02-20`

옵션:

- `랭킹범위` (선택): 기본값 `1..10`
- `날짜` (선택): 기준 날짜, 미입력 시 오늘 기준
- `기간` (선택): 입력하면 단일 랭킹 대신 기간 변화량/히스토리 조회로 동작
- `나만보기` (선택)

자주 발생하는 입력 오류:

- 형식 오류: `랭킹 범위는 '시작..끝' 형식으로 입력해주세요.`
- 범위 오류: `랭킹 범위는 1~100 사이의 숫자로 입력해주세요.`
- 순서 오류: `랭킹 범위는 시작이 끝보다 작거나 같아야 합니다.`

#### `/검색`

특정 캐릭터의 정보를 조회합니다. 하위 명령으로 다음을 선택할 수 있습니다.

- `레벨`: 레벨 히스토리
- `전투력`: 전투력 히스토리
- `레벨랭킹`: 레벨 랭킹 히스토리
- `전투력랭킹`: 전투력 랭킹 히스토리

사용 예시:

- `/검색 레벨 닉네임:캐릭터명`
- `/검색 전투력 닉네임:캐릭터명 기간:14`
- `/검색 레벨랭킹 닉네임:캐릭터명 날짜:-1`
- `/검색 전투력랭킹 닉네임:캐릭터명 기간:30 날짜:2026-02-01 나만보기:true`

옵션:

- `닉네임` (필수)
- `기간` (선택): 미입력 시 기본 `7`
- `날짜` (선택): 기준 날짜, 미입력 시 오늘 기준
- `나만보기` (선택)

동작 특징:

- 닉네임이 확인되면 내부적으로 플레이어 정보를 조회합니다.
- 아직 등록되지 않은 플레이어라면 검색 과정에서 자동 등록될 수 있습니다.

자주 발생하는 입력 오류:

- 닉네임 누락: `닉네임을 입력해주세요.`
- 닉네임 조회 실패: `플레이어 정보를 가져올 수 없습니다. 닉네임을 확인해주세요.`
- 기간 형식 오류: `기간은 숫자로 입력해주세요.`

#### `/유저분포`

특정 날짜 기준 유저 레벨 분포를 조회합니다.

사용 예시:

- `/유저분포`
- `/유저분포 날짜:-1`
- `/유저분포 날짜:2026-02-20 나만보기:true`

옵션:

- `날짜` (선택): 미입력 시 기본 `-1` (어제)
- `나만보기` (선택)

주의:

- `/유저분포`는 오늘 날짜 조회가 허용되지 않습니다.
- 오늘 날짜를 입력하면 `오늘 날짜는 조회할 수 없습니다.` 메시지가 반환됩니다.

#### `/등록`

캐릭터를 일일 정보 저장(추적) 대상 목록에 추가합니다.

사용 예시:

- `/등록 닉네임:캐릭터명`
- `/등록 닉네임:캐릭터명 나만보기:true`

옵션:

- `닉네임` (필수)
- `나만보기` (선택)

실패 가능 상황:

- 닉네임 조회 실패 시 등록되지 않습니다.

#### `/질문`

FAQ 질문에 답변을 받습니다. 정확히 일치하지 않으면 유사 질문 목록을 제공합니다.

사용 예시:

- `/질문 질문:서버 오픈 언제 하나요?`
- `/질문 질문:런처 어떻게 다운받아요? 나만보기:true`

옵션:

- `질문` (필수)
- `나만보기` (선택)

동작 특징:

- 질문을 기반으로 FAQ에서 답변을 검색합니다.
- 유사도 기준에 못 미치면 유사 질문 3개를 제시합니다.
- 유사 답변을 찾지 못하면 로그 채널에서 관리자 멘션을 전송합니다.

### 응답이 느리거나 실패할 때 확인할 점

1. 닉네임 오탈자가 없는지 확인하세요.
2. 날짜 형식이 올바른지 확인하세요. (`YYYY-MM-DD`, `MM-DD`, `DD`, `-n`)
3. 랭킹 범위가 `1..100` 안에 있는지 확인하세요.
4. `/유저분포`에서 오늘 날짜를 요청하지 않았는지 확인하세요.
5. 일시적 오류일 수 있으므로 잠시 후 다시 시도하세요.

## 개발자 가이드

### 프로젝트 개요

- 디스코드 인터랙션 요청을 검증하는 이벤트 핸들러 Lambda와 실제 명령을 처리하는 메인 Lambda로 분리되어 있습니다.
- 유저 랭킹/검색/분포 조회 및 등록 기능을 제공합니다.
- 일별 데이터 스냅샷 기반 조회와 실시간 조회를 함께 사용하는 구조를 포함합니다.
- DB 설계 가이드는 `docs/db_design_guide.md`에 정리되어 있습니다.

### FAQ 인덱스 업데이트

`/질문` 명령은 FAQ 인덱스 바이너리를 사용합니다. FAQ 내용을 수정한 뒤 인덱스를 재생성해야 합니다.
GitHub Actions 배포 워크플로우는 `assets/faq`를 Lambda 패키지에 포함합니다.

인덱스는 `question/aliases/tags`를 `\n` 구분자로 해싱하여 변경된 항목만 재임베딩합니다.
원본 FAQ에서 삭제된 항목은 인덱스에서 제거됩니다.
임베딩 모델이 변경되었거나 메타데이터가 불일치하면 전체 재빌드를 수행합니다.
전체 재빌드를 원하면 기존 `faq_index.npz`를 삭제한 뒤 실행하세요.

예시 파일 경로:

- `assets/faq/faq_data.json`
- `assets/faq/faq_index.npz`

인덱스 생성:

- `.venv\\Scripts\\python.exe scripts/_manage_cmd/build_faq_index.py`

FAQ_DATA_PATH와 FAQ_INDEX_PATH 환경 변수를 설정한 뒤 실행하세요.

관련 환경 변수 (모두 필수):

- `FAQ_DATA_PATH` 예시: `assets/faq/faq_data.json`
- `FAQ_INDEX_PATH` 예시: `assets/faq/faq_index.npz`
- `FAQ_MATCH_THRESHOLD` 예시: `0.8`
- `FAQ_QUERY_CACHE_TTL_SEC` 예시: `300`
- `FAQ_UNANSWERED_TABLE` 예시: `twodays-faq-unanswered`

### 아키텍처 (요약)

1. 디스코드가 인터랙션 요청을 `scripts/discord_event_handler/lambda_function.py`로 전달
2. 이벤트 핸들러 Lambda가 서명(`DISCORD_PUBLIC_KEY`)을 검증
3. 검증 성공 시 메인 Lambda(`scripts/main/lambda_function.py`)를 비동기 호출
4. 메인 Lambda가 슬래시 명령 또는 스케줄 액션(`update_1D`)을 처리
5. Discord API / 외부 프로필 조회 / 저장소(DB) 연동 후 결과 응답 또는 후속 메시지 전송

### 실제 데이터 통합 실행

`lambda_function` 경로를 통해 실제 데이터를 한 번에 실행하고, 생성된 이미지를 `output_dir`로 복사하여 확인할 수 있습니다. Discord 전송은 실제로 수행하지 않고 결과만 기록합니다. `output_dir`는 필수이며 없으면 오류가 발생합니다.

필수 환경 변수:
- `DISCORD_LOG_CHANNEL_ID`
- `DISCORD_ADMIN_ID`
- `DISCORD_TOKEN`
- `DISCORD_APP_ID`
- `SINGLE_TABLE_NAME`
- `AWS_REGION`
- `AWS_ACCESS_KEY`
- `AWS_SECRET_ACCESS_KEY`
- `FONT_PATH`
- `REAL_DATA_PLAYER_NAME` (검색/등록에 사용할 닉네임)

실행 예시:
- CLI: `.venv/bin/python scripts/main/lambda_real_data_runner.py --output-dir /tmp/twodays_lambda_outputs`
- pytest: `RUN_REAL_DATA_LAMBDA_TESTS=1 .venv/bin/python -m pytest -q tests/test_lambda_real_data.py`

### 디렉터리 구조

```text
.
├─ scripts/
│  ├─ discord_event_handler/   # 디스코드 인터랙션 검증 + 메인 Lambda 호출
│  ├─ main/                    # 메인 Lambda, 기능 구현, 도메인/서비스/통합 계층
│  └─ _manage_cmd/             # 디스코드 슬래시 명령 등록/조회/삭제 스크립트
├─ docs/
│  └─ db_design_guide.md       # DB 단일 테이블 설계 가이드
├─ requirements*.txt           # 기능별 의존성 분리
└─ readme.md
```

### 의존성 파일 구성

- `requirements.txt`: 로컬/개발 설치 진입점 (`requirements.dev.txt` 참조)
- `requirements.dev.txt`: 개발용 통합 의존성 (`main` + `event` + `boto3` + `python-dotenv`)
- `requirements.main.txt`: 메인 Lambda 기능 의존성 (예: `pandas`, `matplotlib`, `requests`)
- `requirements.event.txt`: 이벤트 핸들러 Lambda 의존성 (예: `pynacl`)

### 로컬 개발 환경 준비

#### 1) 가상환경 생성 및 활성화 (예시)

```bash
python -m venv .venv
source .venv/bin/activate
```

#### 2) 의존성 설치

```bash
pip install -r requirements.txt
```

### 환경변수 (코드 기준)

#### 공통/메인 Lambda 관련

- `DISCORD_ADMIN_ID`
- `DISCORD_TOKEN`
- `DISCORD_APP_ID`
- `DISCORD_LOG_CHANNEL_ID`
- `SINGLE_TABLE_NAME`
- `AWS_REGION` (기본값: `ap-northeast-2`)
- `AWS_ACCESS_KEY` (로컬 개발 시 선택)
- `AWS_SECRET_ACCESS_KEY` (로컬 개발 시 선택)
- `TWODAYS_LOG_LEVEL` (선택, 기본 `INFO`)
- `FONT_PATH` (필수, 예: 로컬 `assets/fonts/font.ttf`, 배포 환경 `/opt/font.ttf`)

#### 이벤트 핸들러 Lambda 관련

- `DISCORD_PUBLIC_KEY`
- `MAIN_LAMBDA_FUNCTION_NAME`

#### 명령 관리 스크립트 관련

- `DISCORD_APP_ID`
- `DISCORD_TOKEN`
- `DISCORD_GUILD_ID` (길드 명령 등록/조회/삭제 시)

### 디스코드 명령 관리 스크립트

`scripts/_manage_cmd/` 폴더의 스크립트로 슬래시 명령을 관리할 수 있습니다.

- `make_global_cmd.py`: 글로벌 명령 등록
- `make_guild_cmd.py`: 특정 길드 명령 등록
- `get_cmd.py`: 등록된 명령 조회
- `delete_cmd.py`: 등록된 명령 삭제

실행 전 `.env` 또는 셸 환경변수에 Discord 관련 키를 설정해야 합니다.

### 참고 문서

- DB 설계: `docs/db_design_guide.md`
- 업데이트 내역 / 업데이트 예정: `CHANGELOG.md`

### 개발 시 주의사항

- 이 저장소는 AWS Lambda 배포를 전제로 한 구조입니다.
- `scripts/main/lambda_function.py`는 `DISCORD_ADMIN_ID`가 없으면 예외를 발생시킵니다.
- `scripts/discord_event_handler/lambda_function.py`는 디스코드 요청 서명 검증이 실패하면 `401`을 반환합니다.

## 제작자

- [ProDays](https://github.com/Pro-Days)

## 문의사항

- 문의사항은 디스코드 `prodays`로 개인 DM 주세요.

## 라이센스

- `MIT License`
- 자세한 내용은 `LICENSE` 파일을 참고하세요.
